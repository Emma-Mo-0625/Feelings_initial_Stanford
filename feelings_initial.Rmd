---
title: "Emotion Inertia Analysis"
author: "Rongrong (Emma) Mo"
output:
  pdf_document:
    toc: true
    toc_depth: 4
    number_sections: true
fontsize: 11pt
geometry: margin=1in
---

## Descriptive statistics

```{r}
feelings_initial <- load("feelings_initial.RData")
ls()
```

```{r}
summary(feelings_initial)
```

```{r}
str(dat)
```

```{r}
library(dplyr)

participant_info <- dat %>% distinct(subj, age, sex, ethn)
participant_info
```

```{r}
mean_age <- mean(participant_info$age, na.rm = TRUE)
cat("Mean age:", mean_age, "\n")

sd_age <- sd(participant_info$age, na.rm = TRUE)
cat("SD of age:", sd_age, "\n")

female_prop <- mean(participant_info$sex == "female", na.rm = TRUE)
cat("Proportion of female participants:", female_prop)
```


```{r}
summary(dat[, c("Ineg", "Ipos", "Iaro")])
```

- Mean score of Iaro is higher than the other two

```{r}
# identify NAs
colSums(is.na(dat))
```

There are no NAs in the dataset.

```{r}
# identify outliers using z-score

# Calculate Z-scores for Ineg, Ipos, and Iaro
dat$z_Ineg <- scale(dat$Ineg)
dat$z_Ipos <- scale(dat$Ipos)
dat$z_Iaro <- scale(dat$Iaro)

# Identify outliers (Z-score > 3 or < -3)
outliers_Ineg <- dat[abs(dat$z_Ineg) > 3, ]
outliers_Ineg
outliers_Ipos <- dat[abs(dat$z_Ipos) > 3, ]
outliers_Ipos
outliers_Iaro <- dat[abs(dat$z_Iaro) > 3, ]
outliers_Iaro

```

There are no outliers.

## Linear Mixed Effects Model: emotional responses by trial type & demographics

- Each participant has multiple trials, so the trials within a participant are likely correlated
- Data is nested
- Each participant may have their own baseline level of emotional responses

- fixed effects (trial.val, sex, age, ethn) explain the variation between individuals
- random effects (1|subj) explain the correlation of repeated measures within individuals

### How different trial types & demographics affect negative emotional response (Ineg)?

```{r}
library(lme4)

# Mixed-effects model for predicting Ineg
model_ineg <- lmer(Ineg ~ trial.val + sex + age + ethn + (1|subj), data = dat)
summary(model_ineg)

```

- Random effects: each participant has a different baseline emotional response
  - `(1|subj)`: represents the random effect 
    - each participant (subj) has a different baseline deviation (intercept). 
    - This accounts for the correlation between multiple trial results from the same participant
- `REML score` (residual maximum likelihood estimate): assess the model fit
- Fixed Effects:
  - Intercept: Negative trial
  - `trial.valneu` (Neutral trial): Estimate = -4.08, t = -118.57, a very significant negative value. 
    - Compared to the baseline (negative trial), **the neutral trial significantly decreases negative emotions (Ineg)**
  - `trial.valpos` (Positive trial): Estimate = -4.09, t = -168.08, also significant. 
    - **the positive trial also significantly decreases negative emotions** compared to the negative trial
  - sexfemale: Estimate = 0.317543, t = 2.606. 
    - **Females have significantly higher negative emotional responses (Ineg)** compared to males
  - The effects of age and ethnicity are small and not significant


### How different trial types & demographics affect positive emotional response (Ipos)?

```{r}
# Mixed-effects model for predicting Ipos
model_ipos <- lmer(Ipos ~ trial.val + sex + age + ethn + (1|subj), data = dat)
summary(model_ipos)
```

- Intercept (negative trial): estimate = 0.72, t-value = 1.56. The effect of negative trial on positive emotions (Ipos) is small.
- `trial.valneu`: estimate = 0.34, t-value = 9.48. Compared to valneg, the neutral trial significantly increases positive emotions (Ipos).
- `trial.valpos`: estimate = 4.03, t-value = 160.64. Compared to valneg, the positive trial largely increases positive emotions (Ipos), and the effect is extremely significant.
- `sexfemale`: estimate = 0.20, t = 1.58. **Females tend to have slightly higher positive emotional responses** than males.
- `ethnAmerican Indian/Native American or Alaskan Native`: estimate = -0.94, t = -2.30. This ethnicity tends to have **significantly lower positive emotional responses** compared to the reference group (Asian or Pacific Islander).
- `trial.valneu` and `trial.valpos` have a correlation of 0.354, showing that the effects of neutral and positive trials are somewhat related.

### How different trial types & demographics affect arousal emotional response (Iaro)?

```{r}
# Mixed-effects model for predicting Iaro
model_aro <- lmer(Iaro ~ trial.val + sex + age + ethn + (1|subj), data = dat)
summary(model_aro)
```

- Intercept (negative trial): estimate = 2.93, t-value = 3.84. The effect of negative trial on arousal (Iaro) is moderate.
- `trial.valneu`: estimate -2.26, t-value = -64.28. Compared to `valneg`, the **neutral trial significantly decreases arousal (Iaro)**, which can be expected.
- `trial.valpos`: estimate = -0.30, t-value = -12.10. Compared to `valneg`, the **positive trial also significantly decreases arousal (Iaro)**, but the effect is small.
- Other fixed effects are not significant.


## Autoregressive Modeling

### Assign 12 inertia scores for each participant

Assign 1 overall inertia score for pos, neg, and aro for each participant:

```{r}
library(dplyr)
library(purrr)
library(broom)

# Create a function to return inertia (lag-1 beta value)
get_inertia <- function(x) {
  # Create lagged data
  lag_x <- dplyr::lag(x)
  df <- data.frame(current = x, lagged = lag_x)
  df <- na.omit(df)
  
  # Linear regression: current ~ lagged
  model <- lm(current ~ lagged, data = df)
  coef(model)["lagged"]
}

# find inertia scores for the 3 emotions for each participant
overall_inertia <- dat %>%
  group_by(subj) %>%
  summarise(
    pos_inertia = get_inertia(Ipos),
    neg_inertia = get_inertia(Ineg),
    aro_inertia = get_inertia(Iaro)
  )
overall_inertia
```

For each of the 3 emotional reactions (pos, neg, aro), assign 1 inertia score for each of the 3 trial type (pos, neg, neu)

```{r}
library(tidyr)

# For each subj × trial.val × emotion
inertia_long <- dat %>%
  group_by(subj, trial.val) %>%
  summarise(
    pos_inertia = get_inertia(Ipos),
    neg_inertia = get_inertia(Ineg),
    aro_inertia = get_inertia(Iaro),
    .groups = "drop"
  )

# Reshape into wide format: 1 row per participant, 9 inertia scores
inertia_wide <- inertia_long %>%
  pivot_wider(
    names_from = trial.val,
    values_from = c(pos_inertia, neg_inertia, aro_inertia),
    names_glue = "{.value}_{trial.val}"
  )

inertia_wide
```

```{r}
# Find the reason of NAs

# Whether there's not enough data for each subj × trial.val group?

dat %>%
  group_by(subj, trial.val) %>%
  summarise(n = n()) %>%
  filter(n < 5)

# Whether some emotion ratings for certain trial type are always the same?

dat %>%
  group_by(subj, trial.val) %>%
  summarise(
    Ineg_var = var(Ineg),
    Ipos_var = var(Ipos),
    Iaro_var = var(Iaro)
  ) %>%
  filter(Ineg_var == 0 | Ipos_var == 0 | Iaro_var == 0)

```

- The reason of NAs is not due to insufficient data for each subj × trial.val group
- NAs are also not likely to be caused by zero-variance of some emotion inertia ratings, since NAs from inertia_wide are more than the number of Var = 0.


```{r}
# Merge all inertia scores (by subj)
inertia_all <- overall_inertia %>%
  left_join(inertia_wide, by = "subj")
inertia_all
```


```{r}
library(ggplot2)
library(dplyr)
library(tidyr)
library(e1071)   # for skewness
library(psych)   # for describe()

# Convert to inertia_long format
inertia_long <- inertia_all %>%
  pivot_longer(-subj, names_to = "inertia_type", values_to = "inertia")

# Distribution & Skewness
inertia_long %>%
  group_by(inertia_type) %>%
  mutate(
    skew = skewness(inertia, na.rm = TRUE),
    normality_p = shapiro.test(inertia)$p.value
  ) %>%
  ggplot(aes(x = inertia)) +
  geom_histogram(bins = 30, fill = "steelblue", color = "white") +
  facet_wrap(~ inertia_type, scales = "free") +
  theme_minimal() +
  labs(title = "Histogram of Inertia Scores across Participants",
       subtitle = "Check for skewness & normality visually")

```

```{r}
# describe_stats for all 3 + 9 = 12 types of inertia
describe_stats <- inertia_long %>%
  group_by(inertia_type) %>%
  summarise(
    n = sum(!is.na(inertia)),
    sd = sd(inertia, na.rm = TRUE),
    Q1 = quantile(inertia, 0.25, na.rm = TRUE),
    Q3 = quantile(inertia, 0.75, na.rm = TRUE),
    skewness = skewness(inertia, na.rm = TRUE),
    normality_p = shapiro.test(inertia)$p.value
  )
describe_stats
```

Inertia scores that are not normal:

- neg_inertia_pos: normality_p = 6.689087e-10; skewness = 1.07982750
  - Under positive stimuli, negative emotion inertia is right-skewed: a few individuals have unusually persistent negative emotions
- pos_inertia_neg: normality_p = 2.318693e-09; skewness = 1.27067898
  - Under negative stimuli, positive emotion inertia is strongly right-skewed: most people have low inertia in positive feelings, with a few showing strong inertia
- pos_inertia_neu: normality_p = 8.436415e-08; skewness = -0.39896752
  - For neutral stimuli, positive emotion inertia is slightly left-skewed
- neg_inertia_neu: normality_p = 1.296106e-07; skewness = 1.29575508
  - For neutral stimuli, negative emotion inertia is strongly right-skewed
- aro_inertia_neu: normality_p = 3.859573e-05; skewness = 0.71497318
  - For neutral stimuli, arousal inertia is right-skewed


### Normalize the skewed inertia types

```{r}
# Transform the skewed inertia types to normal
library(bestNormalize)

skewed_vars <- c(
  "neg_inertia_pos", "pos_inertia_neg", "pos_inertia_neu",
  "neg_inertia_neu", "aro_inertia_neu"
)

inertia_long_normalized <- inertia_long %>%
  group_by(inertia_type) %>%
  mutate(
    inertia_trans = if_else(
      inertia_type %in% skewed_vars,
      orderNorm(inertia)$x.t,  # transform only these
      inertia  # leave others unchanged
    )
  )

inertia_long_normalized
```


### Compare means and sd of the 12 inertia types

```{r}
# Find mean value of each of the 12 inertia types

inertia_means <- inertia_long_normalized %>%
  group_by(inertia_type) %>%
  summarise(
    mean_inertia = mean(inertia_trans, na.rm = TRUE),
    sd_inertia = sd(inertia_trans, na.rm = TRUE),
    n = sum(!is.na(inertia_trans))
  ) %>%
  arrange(desc(abs(mean_inertia)))

inertia_means
```


- aro_inertia_neu: Extremely high SD (0.998) — arousal inertia under neutral stimuli varies greatly across individuals

- neg_inertia_pos: Negative near-zero mean (-9.32e-06) but very high variance (sd = 0.999); 

  - Negative emotion is likely to bounce back after positive stimuli
  - Huge individual differences
  
- pos_inertia_neg: Negative near-zero mean (-3.28e-05) but very high variance (sd = 0.999);

  - Positive emotion is likely to bounce back after negative stimuli
  - Huge individual differences

#### aro_inertia_neg (mean = 0.031) vs. aro_inertia_pos (mean = 0.007)
  - participants show slightly greater arousal persistence following negative stimuli (M = 0.0308) compared to positive stimuli
  - but the difference is non-significant (p-value = 0.1727)

```{r}
library(dplyr)
library(broom)
library(effectsize)

inertia_compare_aro <- inertia_long_normalized %>%
  filter(inertia_type %in% c("aro_inertia_neg", "aro_inertia_pos")) %>%
  filter(!is.na(inertia_trans))

t_result_aro <- t.test(inertia_trans ~ inertia_type, data = inertia_compare_aro)
print(t_result_aro)

cohen_d_result_aro <- cohens_d(inertia_trans ~ inertia_type, data = inertia_compare_aro)
print(cohen_d_result_aro)

anova_result_aro <- aov(inertia_trans ~ inertia_type, data = inertia_compare_aro)
summary(anova_result_aro)

eta_squared_result_aro <- eta_squared(anova_result_aro, partial = TRUE)
print(eta_squared_result_aro)
```


#### neg_inertia (mean = -0.024) vs. pos_inertia (mean = -0.032):

```{r}
inertia_compare_negpos <- inertia_long_normalized %>%
  filter(inertia_type %in% c("neg_inertia", "pos_inertia")) %>%
  filter(!is.na(inertia_trans))

t_result_negpos <- t.test(inertia_trans ~ inertia_type, data = inertia_compare_negpos)
print(t_result_negpos)

cohen_d_result_negpos <- cohens_d(inertia_trans ~ inertia_type, data = inertia_compare_negpos)
print(cohen_d_result_negpos)

anova_result_negpos <- aov(inertia_trans ~ inertia_type, data = inertia_compare_negpos)
summary(anova_result_negpos)

eta_squared_result_negpos <- eta_squared(anova_result_negpos, partial = TRUE)
print(eta_squared_result_negpos)
```

  - **Negative emotions appeared to decay slightly more slowly (M = –0.024) than positive ones (M = –0.032), but the difference is not significant (p-value = 0.461)**
  - on average, both emotional valences exhibited similarly rapid decay, and individual variability may overshadow any consistent group-level differences
- Cohen's d effect size = 0.08: difference between `neg_inertia` and `pos_inertia` is small


#### neg_inertia_pos (mean = -9.32e-06) vs. pos_inertia_neg (-3.28e-05):

```{r}
inertia_compare_negpos2 <- inertia_long_normalized %>%
  filter(inertia_type %in% c("neg_inertia_pos", "pos_inertia_neg")) %>%
  filter(!is.na(inertia_trans))

t_result_negpos2 <- t.test(inertia_trans ~ inertia_type, data = inertia_compare_negpos2)
print(t_result_negpos2)

cohen_d_result_negpos2 <- cohens_d(inertia_trans ~ inertia_type, data = inertia_compare_negpos2)
print(cohen_d_result_negpos2)

anova_result_negpos2 <- aov(inertia_trans ~ inertia_type, data = inertia_compare_negpos2)
summary(anova_result_negpos2)

eta_squared_result_negpos2 <- eta_squared(anova_result_negpos2, partial = TRUE)
print(eta_squared_result_negpos2)
```

  - Interpretation: **Emotions tend to reset quickly when the stimulus is the opposite, potentially due to contrast effects or attentional shifts, meaning that people are likely to be affected by opposite stimuli**
  - **no statistically significant difference (p = 0.9998)**
- Cohen's d effect size = 2.35e-05: difference between `neg_inertia_pos` and `pos_inertia_neg` is negligible


#### pos_inertia_pos vs. pos_inertia_neg:

```{r}
# pos_inertia_pos vs. pos_inertia_neg: effect size

pos_pos_vs_pos_neg <- inertia_long_normalized %>%
  filter(inertia_type %in% c("pos_inertia_pos", "pos_inertia_neg")) %>%
  filter(!is.na(inertia_trans))

t_result <- t.test(inertia_trans ~ inertia_type, data = pos_pos_vs_pos_neg)
print(t_result)

cohen_d_result <- cohens_d(inertia_trans ~ inertia_type, data = pos_pos_vs_pos_neg)
print(cohen_d_result)

anova_result <- aov(inertia_trans ~ inertia_type, data = pos_pos_vs_pos_neg)
summary(anova_result)

eta_squared_result <- eta_squared(anova_result, partial = TRUE)
print(eta_squared_result)
```

#### neg_inertia_neg vs. neg_inertia_pos:

```{r}
# neg_inertia_neg vs. neg_inertia_pos: effect size

inertia_compare_neg_inertia <- inertia_long_normalized %>%
  filter(inertia_type %in% c("neg_inertia_neg", "neg_inertia_pos")) %>%
  filter(!is.na(inertia_trans))

t_result_neg <- t.test(inertia_trans ~ inertia_type, data = inertia_compare_neg_inertia)
print(t_result_neg)

cohen_d_result_neg <- cohens_d(inertia_trans ~ inertia_type, data = inertia_compare_neg_inertia)
print(cohen_d_result_neg)

anova_result_neg <- aov(inertia_trans ~ inertia_type, data = inertia_compare_neg_inertia)
summary(anova_result_neg)

eta_squared_result_neg <- eta_squared(anova_result_neg, partial = TRUE)
print(eta_squared_result_neg)
```


#### pos_inertia_neu vs. neg_inertia_neu:

```{r}
# pos_inertia_neu vs. neg_inertia_neu: effect size

inertia_compare_neu <- inertia_long_normalized %>%
  filter(inertia_type %in% c("pos_inertia_neu", "neg_inertia_neu")) %>%
  filter(!is.na(inertia_trans))

t_result_neu <- t.test(inertia_trans ~ inertia_type, data = inertia_compare_neu)
print(t_result_neu)

cohen_d_result_neu <- cohens_d(inertia_trans ~ inertia_type, data = inertia_compare_neu)
print(cohen_d_result_neu)

anova_result_neu <- aov(inertia_trans ~ inertia_type, data = inertia_compare_neu)
summary(anova_result_neu)

eta_squared_result_neu <- eta_squared(anova_result_neu, partial = TRUE)
print(eta_squared_result_neu)

```


#### Multivariate ANOVA of 12 inertia types:

```{r}
# Overall there's no statistically significant difference between the 12 inertia types
anova_result <- aov(inertia_trans ~ inertia_type, data = inertia_long_normalized)
summary(anova_result)
```

```{r}
# Find partial eta squared for effect size
partial_eta_squared_result <- eta_squared(anova_result, partial = TRUE)
partial_eta_squared_result
```

- Partial eta squared = 0.0008, which is a very small effect size

#### re-test by Bonferroni

```{r}
# original p-values by pairwise t-test

raw_pvals <- c(
  0.1727,  # aro_inertia_neg vs aro_inertia_pos
  0.4607,  # neg_inertia vs pos_inertia
  0.9998,  # neg_inertia_pos vs pos_inertia_neg
  0.9452,  # pos_inertia_pos vs pos_inertia_neg
  0.7758,  # neg_inertia_neg vs neg_inertia_pos
  0.9997   # pos_inertia_neu vs neg_inertia_neu
)

# Bonferroni adjusted p-values
p.adjust(raw_pvals, method = "bonferroni")
```


### Compare 12 emotional inertia types by demographics

```{r}
# Pivot transformed inertia data to wide format

inertia_wide_trans <- inertia_long_normalized %>%
  select(subj, inertia_type, inertia_trans) %>%
  tidyr::pivot_wider(
    names_from = inertia_type,
    values_from = inertia_trans
  )

# Extract demographic info from your original dat

demo_info <- dat %>%
  select(subj, sex, age, ethn) %>%
  distinct()

# Merge the transformed inertia data with demographics
inertia_full <- inertia_wide_trans %>%
  left_join(demo_info, by = "subj")
inertia_full
```

#### By Sex

```{r}
# Inertia types by Sex (mean)

# By sex
inertia_full %>%
  group_by(sex) %>%
  summarise(across(starts_with("pos_") | starts_with("neg_") | starts_with("aro_"),
                   ~mean(.x, na.rm = TRUE)))
```

- **On average, males showed slightly higher positive emotion inertia (M = –0.021) than females (M = –0.043)**
- pos_inertia_neg: male(0.1255) vs. female(-0.0984)
  - **On average, Females lose positive emotions quickly in response to negative stimuli**
- neg_inertia_pos: male (-0.0489) vs. female(0.0297)
  - **On average, Females retain negative emotions more than males even under positive stimuli -> showing difficulty to let go of negativity**
- This may partly explain why females are more likely to get depression

```{r}
library(dplyr)
library(tidyr)
library(purrr)

# Transform into long_format
inertia_sex_long <- inertia_full %>%
  filter(!is.na(sex)) %>%
  pivot_longer(
    cols = starts_with("pos_") | starts_with("neg_") | starts_with("aro_"),
    names_to = "inertia_type",
    values_to = "inertia_value"
  ) 

# Check for normality using Shapiro test
normality_test <- inertia_sex_long %>%
  group_by(inertia_type, sex) %>%
  filter(n() >= 3) %>%  # Keep groups with sample size >= 3
  summarise(
    n = n(),
    shapiro_p = shapiro.test(inertia_value)$p.value,
    skewness = e1071::skewness(inertia_value, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(normal = ifelse(shapiro_p >= 0.05, "Yes", "No"))

normality_test
```

```{r}
# Check for significant difference by sex with ANOVA
library(broom)

anova_results <- inertia_sex_long %>%
  filter(!is.na(inertia_value), !is.na(sex)) %>%
  group_by(inertia_type) %>%
  do({
    model <- aov(inertia_value ~ sex, data = .)
    tidy(model)
  }) %>%
  filter(term == "sex") %>%
  select(inertia_type, p.value, statistic)
anova_results
```
  
- **one-way ANOVA revealed that these differences were not statistically significant**: among the 12 inertia types, none of them has statistically significant difference in sex

```{r}
# Find eta squared of inertia types by sex
library(effectsize)
library(broom)
library(dplyr)

eta_squared_results <- inertia_sex_long %>%
  filter(!is.na(inertia_value), !is.na(sex)) %>%
  group_by(inertia_type) %>%
  do({
    model <- aov(inertia_value ~ sex, data = .)
    
    # broom::tidy for F and p-value
    tidy_model <- tidy(model) %>%
      filter(term == "sex")
    
    if(nrow(tidy_model) > 0){
      # eta squared
      eta_sq <- eta_squared(model, partial = TRUE) %>%
        filter(Parameter == "sex")
      
      data.frame(
        inertia_type = unique(.$inertia_type),
        F_value = tidy_model$statistic,
        p_value = tidy_model$p.value,
        partial_eta_squared = eta_sq$Eta2
      )
    } else {
      data.frame(
        inertia_type = unique(.$inertia_type),
        F_value = NA,
        p_value = NA,
        partial_eta_squared = NA
      )
    }
  })

print(eta_squared_results)
```

```{r}
# Cohen's d between male and female
library(effectsize)
library(dplyr)

cohens_d_results <- inertia_sex_long %>%
  filter(!is.na(inertia_value), sex %in% c("male", "female")) %>%
  group_by(inertia_type) %>%
  nest() %>%
  mutate(
    cohens_d = map_dbl(data, ~ cohens_d(inertia_value ~ sex, data = .x)$Cohens_d[1])
  ) %>%
  select(inertia_type, cohens_d)

print(cohens_d_results)
```

```{r}
# retest sex difference by Bonferroni

Bonferroni_results <- eta_squared_results %>%
  ungroup() %>%
  mutate(bonferroni_p = p.adjust(p_value, method = "bonferroni"))
Bonferroni_results
```

- All stay non-significant after Bonferroni correction
  - no significant difference between sex for each of the inertia types

#### By ethnicity

```{r}
# By ethnicity (mean)
inertia_full %>%
  group_by(ethn) %>%
  summarise(across(starts_with("pos_") | starts_with("neg_") | starts_with("aro_"), ~mean(., na.rm = TRUE)))
```

On average (without checking for statistical significance):
- **American Indian/Native American or Alaskan Native: the only group with neg_inertia > 0 (0.086) -> tend to stay in negative states longer**
- **Black/African American: the only group with pos_inertia > 0 (0.007) -> tend to stay in positive states longer (which is unexpected)**
- **White/Caucasian: the only group with inertia < 0 across all three emotions (general pos, neg, aro) -> tend to bounce back quickly overall (emotionally adaptive).**
  - This may reflect greater access to resources, social safety nets, and less exposure to systemic stressors for White people.
- **Both "Other" and "Decline to state" have much higher aro_inertia than others.**
  - This may suggest that the people who are less confident or more confused about their identities are likely to face heightened stress, social vigilance, or lack of belonging--all known to elevate arousal.
- But these patterns **did not reach statistical significance**

```{r}
# By ethnicity (check for significance)

library(tidyr)
library(dplyr)
library(purrr)
library(broom)

inertia_ethn_long <- inertia_full %>%
  filter(!is.na(ethn)) %>%
  pivot_longer(
    cols = matches("inertia"),
  names_to = "inertia_type",
  values_to = "inertia_value"
  )

# Check for significant between-group difference using ANOVA

library(broom)

anova_ethn_results <- inertia_ethn_long %>%
  filter(!is.na(inertia_value), !is.na(ethn)) %>%
  group_by(inertia_type) %>%
  do(tidy(aov(inertia_value ~ ethn, data = .))) %>%
  filter(term == "ethn") %>%
  select(inertia_type, p.value, statistic)

anova_ethn_results
```

2 types show statistically significant difference:
- neg_inertia_neu: p = 0.0317
- neg_inertia_pos: p = 0.0243

```{r}
# post-hoc: check which groups have the difference using TukeyHSD

# neg_inertia_neu
model_neu <- aov(inertia_value ~ ethn, data = filter(inertia_ethn_long, inertia_type == "neg_inertia_neu"))
TukeyHSD(model_neu)

```
- significant difference in `neg_inertia_neu` (p-value = 0.0217) between Latino/Hispanic (M = 0.7943) and Asian/ Pacific Islander (M = -0.5886)
  - Latino/Hispanic individuals showed greater negative inertia in response to neutral stimuli, potentially reflecting a stronger tendency to maintain negative emotional responses in ambiguous or emotionally neutral contexts

```{r}
# neg_inertia_pos
model_pos <- aov(inertia_value ~ ethn, data = filter(inertia_ethn_long, inertia_type == "neg_inertia_pos"))
TukeyHSD(model_pos)
```

- No pairwise group differences are significant for neg_inertia_pos

```{r}
# partial eta squared for each inertia type
eta_squared_ethn_results <- inertia_ethn_long %>%
  filter(!is.na(inertia_value), !is.na(ethn)) %>%
  group_by(inertia_type) %>%
  do({
    model <- aov(inertia_value ~ ethn, data = .)
    
    tidy_model <- tidy(model) %>%
      filter(term == "ethn")
    
    if (nrow(tidy_model) > 0) {
      eta_sq <- eta_squared(model, partial = TRUE) %>%
        filter(Parameter == "ethn")
      
      data.frame(
        inertia_type = unique(.$inertia_type),
        F_value = tidy_model$statistic,
        p_value = tidy_model$p.value,
        partial_eta_squared = eta_sq$Eta2
      )
    } else {
      data.frame(
        inertia_type = unique(.$inertia_type),
        F_value = NA,
        p_value = NA,
        partial_eta_squared = NA
      )
    }
  })

print(eta_squared_ethn_results)

```

```{r}
# retest ethnicity difference by Bonferroni
Bonferroni_results_ethn <- eta_squared_ethn_results %>%
  ungroup() %>%
  mutate(
    bonferroni_p = p.adjust(p_value, method = "bonferroni"),
    significant = bonferroni_p < 0.05
  )
Bonferroni_results_ethn
```

- All become non-significant after Bonferroni correction, even `neg_inertia_neu` and `neg_inertia_pos`, the only two significant inertia types from the original p-value test


#### by age

```{r}
# Inertia types by Age (continuous)

inertia_full %>%
  summarise(across(
    starts_with("pos_") | starts_with("neg_") | starts_with("aro_"),
    ~ cor(., age, use = "complete.obs")
  ))
```

- On average, as age increases, neg_inertia (-0.128) decreases more than pos_inertia (-0.011). 
  - Negative emotion may drop slightly faster with increasing age than positive emotion
- Arousal shows a slight increase with age (0.029)
- However, none of these associations reached statistical significance

```{r}
# Check for significant difference of inertia by age

inertia_long_age <- inertia_full %>%
  pivot_longer(cols = starts_with("pos_") | starts_with("neg_") | starts_with("aro_"),
               names_to = "inertia_type",
               values_to = "inertia_value")

# run correlation tests

age_corr_results <- inertia_long_age %>%
  filter(!is.na(inertia_value), !is.na(age)) %>%
  group_by(inertia_type) %>%
  summarise(
    cor_test = list(cor.test(inertia_value, age, method = "pearson")),
    .groups = "drop"
  ) %>%
  mutate(
    r = map_dbl(cor_test, ~ .x$estimate),
    p_value = map_dbl(cor_test, ~ .x$p.value)
  )
age_corr_results
```

- only `pos_inertia_neu` vary significantly by age: r = -0.1956, p = 0.0257
  - as age increases, positive emotion inertia under neutral conditions tends to decrease
  - **older individuals may be less likely to maintain positive emotions in response to neutral stimuli**
  
  
```{r}
# retest age difference by Bonferroni
age_corr_results <- age_corr_results %>%
  mutate(
    bonferroni_p = p.adjust(p_value, method = "bonferroni"),
    significant = bonferroni_p < 0.05
  )
age_corr_results
```

- All become non-significant after Bonferroni correction, even `pos_inertia_neu`, the only significant inertia type from the original correlation test


### Correlation between inertia types

```{r}
inertia_core <- inertia_full %>%
  select(subj, pos_inertia, neg_inertia, aro_inertia)
cor_matrix <- cor(inertia_core[,-1], use = "complete.obs")
cor_matrix
```

```{r}
library(ggcorrplot)

ggcorrplot(cor_matrix,
           method = "circle",
           type = "lower",
           lab = TRUE,
           title = "Correlation Among Emotional Inertia Types")

```

- `pos_inertia` and `neg_inertia` have moderate positive correlation (r = 0.401): people who tend to hold onto positive emotions also tend to hold onto negative emotions, suggesting emotional stickiness
- `aro_inertia` and `neg_inertia` have small-to-moderate positive correlation (r = 0.278): those who hold onto negative emotions also tend to stay aroused longer


## CLPM

### Cross-lag paths (how one emotion affect another at the next time point) & Inertia

```{r}
library(lavaan)
library(dplyr)

clpm_data <- dat %>%
  arrange(subj, trial.num) %>%
  group_by(subj) %>%
  mutate(
    Ipos_lag1 = lag(Ipos),
    Ineg_lag1 = lag(Ineg),
    Iaro_lag1 = lag(Iaro)
  ) %>%
  filter(!is.na(Ipos_lag1))

model_clpm <- '
  # Autoregressive (inertia) paths
  Ipos ~ a1 * Ipos_lag1
  Ineg ~ a2 * Ineg_lag1
  Iaro ~ a3 * Iaro_lag1
  
  # Cross-lagged paths
  Ipos ~ b1 * Ineg_lag1 + b2 * Iaro_lag1
  Ineg ~ c1 * Ipos_lag1 + c2 * Iaro_lag1
  Iaro ~ d1 * Ipos_lag1 + d2 * Ineg_lag1
'

fit_clpm <- sem(model_clpm, data = clpm_data)
summary(fit_clpm, standardized = TRUE, fit.measures = TRUE)
```

- Positive inertia (0.137) and negative inertia (0.143) are about the same. Negative is slightly higher than positive.
- Arousal inertia (0.414) is much higher than the other two, meaning that arousal emotion is more likely to persist (slightly higher arousal inertia)
- All three types of emotional states (positive, negative, and arousal) exhibit significant inertia, with arousal showing the strongest carry-over effect from one trial to the next

- Ipos ~ Ineg_lag1 ($\beta$ = 0.166, p < .001): negative emotion predicts positive emotion in the next moment, which might reflect emotional rebound
- Ineg ~ Ipos_lag1 ($\beta$ = 0.172, p < .001): positive emotion enhances negative emotion in the next moment, which might reflect emotional mix or trial order effect
- Iaro ~ Ipos_lag1 ($\beta$ = -0.053): positive emotion decreases arousal at the later stage
- Iaro ~ Ineg_lag1 ($\beta$ = -0.078): negative emotion decreases arousal at the later stage
- Ipos ~ Iaro_lag1 and Ineg ~ Iaro_lag1 are not significant

- Conclusion: 
  - **Both positive and negative emotions predict more of the opposite in the next moment**
  - **Arousal is reduced by both positive and negative emotions**
    - maybe a sign of emotional rebound or recovery
    - more likely to be a result of individual differences (some people are more responsive than others) under random trials within an experimental context, where individuals have “regression to the mean”. This might not be the case in real/natural context


#### Difference in paths by sex

```{r}
# Group by sex

fit_clpm_sex <- sem(model_clpm, 
                    data = clpm_data, 
                    group = "sex")
summary(fit_clpm_sex, standardized = TRUE, fit.measures = TRUE)

```

- Most of the paths are similar between men and women
- Only arousal inertia for women is slightly higher than men

```{r}
# Check for significant difference between men and women

model_clpm_free <- '
  # Inertia paths
  Ipos ~ c(a1f, a1m, a1o)*Ipos_lag1
  Ineg ~ c(a2f, a2m, a2o)*Ineg_lag1
  Iaro ~ c(a3f, a3m, a3o)*Iaro_lag1

  # Cross-lag
  Ipos ~ c(b1f, b1m, b1o)*Ineg_lag1 + c(b2f, b2m, b2o)*Iaro_lag1
  Ineg ~ c(c1f, c1m, c1o)*Ipos_lag1 + c(c2f, c2m, c2o)*Iaro_lag1
  Iaro ~ c(d1f, d1m, d1o)*Ipos_lag1 + c(d2f, d2m, d2o)*Ineg_lag1
'


fit_free <- sem(model_clpm_free, data = clpm_data, group = "sex")

# Whether there's significant difference between sex in at least one path
anova(fit_clpm_sex, fit_free)
```

- This shows that at least one or more paths (inertia or cross-lag) differ between males and females

```{r}
# Check which paths are significantly different

lavTestScore(fit_clpm_sex)
```

- .p3. vs. .p30. and .p3. vs. .p57.	are significant (p < 0.05)

```{r}
# Understand which paths are them

pe <- parameterEstimates(fit_clpm_sex, standardized = TRUE)
pe[c(3, 30, 57), c("lhs", "op", "rhs", "group", "est", "std.all")]
```

- females (0.413) and males (0.402) are significantly different in arousal inertia
- females (0.413) and other (0.356) are also significantly different in arousal inertia

#### Difference in paths by ethnicity

```{r}
model_clpm_nolabel <- '
  Ipos ~ Ipos_lag1 + Ineg_lag1 + Iaro_lag1
  Ineg ~ Ineg_lag1 + Ipos_lag1 + Iaro_lag1
  Iaro ~ Iaro_lag1 + Ipos_lag1 + Ineg_lag1
'

fit_multigroup_free <- sem(model_clpm_nolabel, data = clpm_data, group = "ethn")
summary(fit_multigroup_free, standardized = TRUE)
```

- Asian or Pacific Islander:
  - strong arousal inertia ($\beta$ = .43, p < .001).
  - Both prior positive ($\beta$ = –.05, p = .031) and negative emotion ($\beta$ = –.08, p < .001) significantly reduced subsequent arousal

- Black/African American:
  - Strongest Ipos inertia (0.187) among all groups
  - Arousal -> Positive emotion path is negative and significant (-0.085), suggesting arousal suppresses positivity here

- Latino/Hispanic:
  - Uniquely positive effect from prior arousal to later positive emotion (0.189).
  - Had the strongest Iaro inertia (0.483).

- White/Caucasian:
  - Negative cross-effects from both Ipos to Iaro (-0.078) and Ineg to Iaro (-0.090), showing a strong regulatory suppression of arousal by both emotion valences.
  - Effects tend to be more stable across emotional domains.

- American Indian/Native American or Alaskan Native:
  - The highest negative emotion inertia ($\beta$ = .21, p = .005)
  - The only group where prior negative emotion significantly increased arousal ($\beta$ = .16, p = .037)"

#### Difference in paths by age

```{r}
library(dplyr)
library(broom)

# cross-lagged paths to analyze
paths <- list(
  Ipos_on_Ineg = c("Ipos", "Ineg_lag1"),
  Ipos_on_Aro = c("Ipos", "Iaro_lag1"),
  Ineg_on_Ipos = c("Ineg", "Ipos_lag1"),
  Ineg_on_Aro = c("Ineg", "Iaro_lag1"),
  Iaro_on_Ipos = c("Iaro", "Ipos_lag1"),
  Iaro_on_Ineg = c("Iaro", "Ineg_lag1")
)

results <- data.frame(path = character(), r = numeric(), p = numeric())

# run regression for each path + correlation with age
for (path_name in names(paths)) {
  lhs <- paths[[path_name]][1]
  rhs <- paths[[path_name]][2]
  
  # model each participant
  path_df <- clpm_data %>%
    group_by(subj) %>%
    filter(!is.na(.data[[lhs]]), !is.na(.data[[rhs]])) %>%
    do(tidy(lm(as.formula(paste(lhs, "~", rhs)), data = .))) %>%
    filter(term == rhs) %>%
    rename(estimate = estimate) %>%
    left_join(select(dat, subj, age), by = "subj")
  
  # find correlation with age
  cor_result <- cor.test(path_df$estimate, path_df$age)
  
  results <- rbind(results, data.frame(
    path = path_name,
    r = cor_result$estimate,
    p = cor_result$p.value
  ))
}

print(results)
```

- Ipos_on_Ineg: As age increases, negative emotion exerts a stronger influence on subsequent positive emotion (r = 0.124, p < .001)
- Ipos_on_Aro: Higher arousal increasingly boosts next-step positive emotion with greater age (r = 0.202, p < .001)
- Ineg_on_Aro: Higher arousal is linked with lower next-step negative emotion, especially as age increases
- Iaro_on_Ineg: With age, the influence of negative emotion on subsequent arousal slightly decreases (r = -0.038, p < .001)

